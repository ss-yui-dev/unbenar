namespace = DA_Magma_forge_event

province_event = {
	id = DA_Magma_forge_event.1 #unlocks magma forge restoration
	title = "DA_Magma_forge_event.1.t"
	desc = "DA_Magma_forge_event.1.d"
	picture = MAGIC_STUDY_AND_RELAX_eventPicture

	fire_only_once = yes
	trigger = {
		culture_group = dwarven
		province_id = 4039
		has_province_flag = DA_Magma_forge_found
		NOT = {	has_province_flag = DA_restorable_MF }
		owner = {
			capital_scope = {
				has_province_flag = DA_Expanded_dig_adk_2
			}
		}
	}	
	mean_time_to_happen = {
		months = 132
		modifier = {
			factor = 2
			owner = {
				NOT = { innovativeness = 10 }
			}
			
		}
		modifier = {
			factor = 0.9
			owner = {
				innovativeness = 40
			}
		}
		modifier = {
			factor = 0.9
			owner = {
				innovativeness = 60
			}
		}
		modifier = {
			factor = 0.9
			owner = {
				innovativeness = 80
			}
		}
		modifier = {
			factor = 0.9
			owner = {
				stability = 3
			}
		}
		modifier = {
			factor = 0.85
			owner = {
				has_country_modifier = DA_Runesmith_patronage
			}
		}
		modifier = {
			factor = 0.90
			owner = {
				OR = {
					has_estate_privilege = estate_DA_Runesmiths_RF_4
					has_estate_privilege = estate_DA_Runesmiths_RF_5
				}
			}
		}
		modifier = {
			factor = 0.85
			owner = {
				OR = {
					has_estate_privilege = estate_DA_Runesmiths_RF_6
					has_estate_privilege = estate_DA_Runesmiths_RF_7
				}
			}
		}
		modifier = {
			factor = 0.80
			owner = {
				OR = {
					has_estate_privilege = estate_DA_Runesmiths_RF_8
					has_estate_privilege = estate_DA_Runesmiths_RF_9
					has_estate_privilege = estate_DA_Runesmiths_RF_10
					has_estate_privilege = estate_DA_Runesmiths_RF_11
				}
			}
		}
	}
	option = {
		name = "DA_Magma_forge_event.1.a"
		custom_tooltip = DA_Magma_forge_event.1.tooltip
		hidden_effect = { set_province_flag = DA_restorable_MF }
	}	
}


country_event = {
	id = DA_Magma_forge_event.2 #restore magma forge
	title = "DA_Magma_forge_event.2.t"
	desc = "DA_Magma_forge_event.2.d"
	picture = INVENTION_eventPicture

	is_triggered_only = yes

	option = {
		name = "DA_Magma_forge_event.2.a"
		add_treasury = -2000
		hidden_effect = { subtract_variable = { ancientDwarvenKnowledge = 12 } }
		custom_tooltip = DA_Magma_forge_event.2.tooltip
		every_core_province = {
			limit = {
				has_province_flag = DA_restorable_MF
				has_province_modifier = DA_GB_vulcano_unregulated
			}
			remove_province_modifier = DA_GB_vulcano_unregulated
			add_permanent_province_modifier = {
				name = DA_GB_vulcano_regulated
				duration = -1
			}
		}
	}
	after = {
		hidden_effect = {
			clr_country_flag = DA_rf_menu_in_use
		}
	}	
}

province_event = {
	id = DA_Magma_forge_event.3 #hidden event which increases magma level
	title = "DA_Magma_forge_event.3.t"
	desc = "DA_Magma_forge_event.3.d"
	picture = MAGIC_STUDY_AND_RELAX_eventPicture

	hidden = yes
	trigger = {
		province_id = 4039
		has_province_flag = DA_Magma_forge_found
		OR = {
			NOT = {
				check_variable = {
					which = DA_Magma_level
					value = 100
				}
			}
			AND = {
				NOT = {
					check_variable = {
						which = DA_Magma_level
						value = 200
					}
				}
				has_province_flag = DA_Expanded_magma_forge_cap1
			}
		}
	}
	mean_time_to_happen = {
		months = 2
	}
	option = {
		name = "DA_Magma_forge_event.3.a"
		if = {
			limit = { has_province_flag = DA_Expanded_magma_forge_cap1 }
			change_variable = {
				which = DA_Magma_level
				value = 2
			}
		}
		else = {
			change_variable = {
				which = DA_Magma_level
				value = 1
			}
		}
	}	
}


province_event = {
	id = DA_Magma_forge_event.4 # devastation event, can spawn unregulated magma veins
	title = "DA_Magma_forge_event.4.t"
	desc = "DA_Magma_forge_event.4.d"
	picture = CIVIL_WAR_eventPicture

	trigger = {
		OR = {
			province_id = 2949
			province_id = 4037
			province_id = 4038
			province_id = 4039
			province_id = 4040
			province_id = 4041
			province_id = 4042
		}
		NOT = { has_province_modifier = DA_MF_devastation_cooldown }
		NOT = { has_province_modifier = DA_unregulated_magma_vein }
		owner = {
			any_core_province = {
				has_province_flag = DA_Magma_forge_found
				NOT = { has_province_modifier = DA_GB_vulcano_regulated }
			}
		}
	}
	mean_time_to_happen = {
		months = 10
		modifier = {
			factor = 0.9
			check_variable = {
				which = DA_Magma_level
				value = 30
			}
		}
		modifier = {
			factor = 0.9
			check_variable = {
				which = DA_Magma_level
				value = 50
			}
		}
		modifier = {
			factor = 0.9
			check_variable = {
				which = DA_Magma_level
				value = 70
			}
		}
		modifier = {
			factor = 0.8
			check_variable = {
				which = DA_Magma_level
				value = 90
			}
		}
	}
	option = {
		name = "DA_Magma_forge_event.4.a"
		if = {
			limit = { 
				devastation = 10
				NOT = { province_id = 4039 }
			}
			add_permanent_province_modifier = {
				name = DA_unregulated_magma_vein
				duration = -1
			}
		}
		add_devastation = 25
		hidden_effect = {
			add_permanent_province_modifier = {
				name = DA_MF_devastation_cooldown
				duration = 365
				hidden = yes
			}
		}
	}	
}



country_event = {
	id = DA_Magma_forge_event.10 # magma forge menu
	title = "DA_Magma_forge_event.10.t"
	desc = "DA_Magma_forge_event.10.d"
	picture = FORGE_eventPicture

	is_triggered_only = yes

	option = {
		name = "DA_Magma_forge_event.10.a"	# regulate magma veins
		trigger = {
			treasury = 750
			has_country_flag = DA_MF_regulate_veins
			any_core_province = {
				has_province_flag = DA_Magma_forge_found
				check_variable = {
					which = DA_Magma_level
					value = 80
				}
			}
			any_core_province = {
				has_province_modifier = DA_unregulated_magma_vein
			}
		}
		add_treasury = -750
		hidden_effect = { subtract_variable = { ancientDwarvenKnowledge = 6 } }
		custom_tooltip = DA_Magma_forge_event.10.a.tooltip
		every_core_province = {
			limit = {
				has_province_modifier = DA_unregulated_magma_vein
			}
			remove_province_modifier = DA_unregulated_magma_vein
			add_permanent_province_modifier = {
				name = DA_regulated_magma_vein
				duration = -1
			}
		}
		hidden_effect = {
			every_core_province = {
				limit = {
					has_province_flag = DA_Magma_forge_found
				}
				subtract_variable = {
					which = DA_Magma_level
					value = 80
				}
			}
		}
	}
	
	option = {
		name = "DA_Magma_forge_event.10.b"	# increase magma level cap
		trigger = {
			treasury = 1000
			has_country_flag = DA_MF_regulate_veins
			any_core_province = {
				has_province_flag = DA_Magma_forge_found
				NOT = { has_province_flag = DA_Expanded_magma_forge_cap1 }
				check_variable = {
					which = DA_Magma_level
					value = 100
				}
			}
		}
		add_treasury = -1000
		custom_tooltip = DA_Magma_forge_event.10.b.tooltip
		hidden_effect = {
			every_core_province = {
				limit = {
					has_province_flag = DA_Magma_forge_found
				}
				set_province_flag = DA_Expanded_magma_forge_cap1
				subtract_variable = {
					which = DA_Magma_level
					value = 100
				}
			}
		}
	}
	
	option = {
		name = "DA_Magma_forge_event.10.c"	# form new magma vein
		trigger = {
			treasury = 1250
			has_country_flag = DA_MF_can_create_regulated_veins
			check_variable = { ancientDwarvenKnowledge = 5 }
			any_core_province = {
				OR = {
					has_terrain = dwarven_hold
					has_terrain = dwarven_hold_surface
				}
				NOT = { has_province_modifier = DA_regulated_magma_vein }
				DA_has_dig_level_5_or_higher = yes
			}
			any_core_province = {
				has_province_flag = DA_Expanded_magma_forge_cap1
				check_variable = {
					which = DA_Magma_level
					value = 100
				}
			}
		}
		country_event = {
			id = DA_Magma_forge_event.13
		}
		custom_tooltip = DA_Magma_forge_event.10.c.tooltip
	}
	option = {
		name = "DA_Magma_forge_event.10.e"	# build basalt wall
		trigger = {
			treasury = 1000
			has_country_flag = DA_MF_can_create_Basalt_Wall
			NOT = { has_country_flag = DA_MF_can_create_Basalt_Wall_2 }
			any_core_province = {
				province_id = 672
				owned_by = root
				has_missionary = no
				has_colonist = no
				NOT = { has_construction = any }
			}
			any_core_province = {
				has_province_flag = DA_Expanded_magma_forge_cap1
				check_variable = {
					which = DA_Magma_level
					value = 200
				}
			}
		}
		country_event = {
			id = DA_Magma_forge_event.15
		}
		hidden_effect = {
			set_country_flag = DA_MF_can_create_Basalt_Wall_2
		}
		custom_tooltip = DA_Magma_forge_event.10.e.tooltip
	}
	option = {
		name = "DA_Magma_forge_event.10.Go_Back"
	}
	after = {
		hidden_effect = {
			clr_country_flag = DA_rf_menu_in_use
		}
	}	
}


country_event = {
	id = DA_Magma_forge_event.11 # unlock regulating magma veins
	title = "DA_Magma_forge_event.11.t"
	desc = "DA_Magma_forge_event.11.d"
	picture = FORGE_eventPicture

	trigger = {
		capital_scope = {
			has_province_flag = DA_Expanded_dig_adk_5 # research facility lvl 5
		}
		NOT = { has_country_flag = DA_MF_regulate_veins }
		any_core_province = {
			has_province_modifier = DA_GB_vulcano_regulated
		}
	}
	mean_time_to_happen = {
		months = 90
		modifier = {
			factor = 0.85
			has_country_modifier = DA_Runesmith_patronage
		}
		modifier = {
			factor = 0.90
			OR = {
				has_estate_privilege = estate_DA_Runesmiths_RF_4
				has_estate_privilege = estate_DA_Runesmiths_RF_5
			}
		}
		modifier = {
			factor = 0.85
			OR = {
				has_estate_privilege = estate_DA_Runesmiths_RF_6
				has_estate_privilege = estate_DA_Runesmiths_RF_7
			}
		}
		modifier = {
			factor = 0.80
			OR = {
				has_estate_privilege = estate_DA_Runesmiths_RF_8
				has_estate_privilege = estate_DA_Runesmiths_RF_9
				has_estate_privilege = estate_DA_Runesmiths_RF_10
				has_estate_privilege = estate_DA_Runesmiths_RF_11
			}
		}
	}

	option = {
		name = "DA_Magma_forge_event.11.a"
		custom_tooltip = DA_Magma_forge_event.11.a.tooltip
		set_country_flag = DA_MF_regulate_veins
	}
}

country_event = {
	id = DA_Magma_forge_event.12 					# unlock creating regulated magma veins in holds with dig 4 or higher
	title = "DA_Magma_forge_event.12.t"
	desc = "DA_Magma_forge_event.12.d"
	picture = FORGE_eventPicture

	trigger = {
		capital_scope = {
			has_province_flag = DA_Expanded_dig_adk_6			# research facility lvl 6
		}
		has_country_flag = DA_MF_regulate_veins
		NOT = { has_country_flag = DA_MF_can_create_regulated_veins }
		any_core_province = {
			owned_by = root
			has_province_modifier = DA_GB_vulcano_regulated
		}
	}
	mean_time_to_happen = {
		months = 120
		modifier = {
			factor = 0.85
			has_country_modifier = DA_Runesmith_patronage
		}
		modifier = {
			factor = 0.90
			OR = {
				has_estate_privilege = estate_DA_Runesmiths_RF_4
				has_estate_privilege = estate_DA_Runesmiths_RF_5
			}
		}
		modifier = {
			factor = 0.85
			OR = {
				has_estate_privilege = estate_DA_Runesmiths_RF_6
				has_estate_privilege = estate_DA_Runesmiths_RF_7
			}
		}
		modifier = {
			factor = 0.80
			OR = {
				has_estate_privilege = estate_DA_Runesmiths_RF_8
				has_estate_privilege = estate_DA_Runesmiths_RF_9
				has_estate_privilege = estate_DA_Runesmiths_RF_10
				has_estate_privilege = estate_DA_Runesmiths_RF_11
			}
		}
	}

	option = {
		name = "DA_Magma_forge_event.12.a"
		custom_tooltip = DA_Magma_forge_event.12.a.tooltip
		set_country_flag = DA_MF_can_create_regulated_veins
		ai_chance = {
			factor = 1
		}
	}
}

country_event = {    # magma vein formation
	id = DA_Magma_forge_event.13 
	title = "DA_Magma_forge_event.13.t"
	desc = "DA_Magma_forge_event.13.d"
	picture = FORGE_eventPicture

	is_triggered_only = yes
	immediate = {
		random_core_province = {
			limit = {
				OR = {
					has_terrain = dwarven_hold
					has_terrain = dwarven_hold_surface
				}
				NOT = { has_province_modifier = DA_regulated_magma_vein }
				DA_has_dig_level_5_or_higher = yes
			}
			save_event_target_as = DA_potential_magma_vein1
		}
		random_core_province = {
			limit = {
				OR = {
					has_terrain = dwarven_hold
					has_terrain = dwarven_hold_surface
				}
				NOT = { has_province_modifier = DA_regulated_magma_vein }
				DA_has_dig_level_5_or_higher = yes
				NOT = { province_id = event_target:DA_potential_magma_vein1 }
			}
			save_event_target_as = DA_potential_magma_vein2
		}
		random_core_province = {
			limit = {
				OR = {
					has_terrain = dwarven_hold
					has_terrain = dwarven_hold_surface
				}
				NOT = { has_province_modifier = DA_regulated_magma_vein }
				DA_has_dig_level_5_or_higher = yes
				NOT = { province_id = event_target:DA_potential_magma_vein1 }
				NOT = { province_id = event_target:DA_potential_magma_vein2 }
			}
			save_event_target_as = DA_potential_magma_vein3
		}
	}
	option = {
		name = "DA_Magma_forge_event.13.a"
		goto = DA_potential_magma_vein1
		trigger = {
			event_target:DA_potential_magma_vein1 = {
				OR = {
					has_terrain = dwarven_hold
					has_terrain = dwarven_hold_surface
				}
				NOT = { has_province_modifier = DA_regulated_magma_vein }
				DA_has_dig_level_5_or_higher = yes
			}
		}
		add_treasury = -1250
		custom_tooltip = DA_Magma_forge_event.13.tooltip
		hidden_effect = { subtract_variable = { ancientDwarvenKnowledge = 5 } }
		hidden_effect = {
			every_core_province = {
				limit = {
					has_province_flag = DA_Magma_forge_found
				}
				subtract_variable = {
					which = DA_Magma_level
					value = 140
				}
			}
		}
		event_target:DA_potential_magma_vein1 = {
			add_permanent_province_modifier = {
				name = DA_regulated_magma_vein
				duration = -1
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 10
				treasury = 7000
			}
		}
	}
	option = {
		name = "DA_Magma_forge_event.13.b"
		goto = DA_potential_magma_vein2
		trigger = {
			event_target:DA_potential_magma_vein2 = {
				OR = {
					has_terrain = dwarven_hold
					has_terrain = dwarven_hold_surface
				}
				NOT = { has_province_modifier = DA_regulated_magma_vein }
				DA_has_dig_level_5_or_higher = yes
			}
		}
		add_treasury = -1250
		custom_tooltip = DA_Magma_forge_event.13.tooltip
		hidden_effect = { subtract_variable = { ancientDwarvenKnowledge = 5 } }
		hidden_effect = {
			every_core_province = {
				limit = {
					has_province_flag = DA_Magma_forge_found
				}
				subtract_variable = {
					which = DA_Magma_level
					value = 140
				}
			}
		}
		event_target:DA_potential_magma_vein2 = {
			add_permanent_province_modifier = {
				name = DA_regulated_magma_vein
				duration = -1
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 10
				treasury = 7000
			}
		}
	}
	option = {
		name = "DA_Magma_forge_event.13.c"
		goto = DA_potential_magma_vein3
		trigger = {
			event_target:DA_potential_magma_vein3 = {
				OR = {
					has_terrain = dwarven_hold
					has_terrain = dwarven_hold_surface
				}
				NOT = { has_province_modifier = DA_regulated_magma_vein }
				DA_has_dig_level_5_or_higher = yes
			}
		}
		add_treasury = -1250
		custom_tooltip = DA_Magma_forge_event.13.tooltip
		hidden_effect = { subtract_variable = { ancientDwarvenKnowledge = 5 } }
		hidden_effect = {
			every_core_province = {
				limit = {
					has_province_flag = DA_Magma_forge_found
				}
				subtract_variable = {
					which = DA_Magma_level
					value = 140
				}
			}
		}
		event_target:DA_potential_magma_vein3 = {
			add_permanent_province_modifier = {
				name = DA_regulated_magma_vein
				duration = -1
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 10
				treasury = 7000
			}
		}
	}
	option = {
		name = "DA_Magma_forge_event.13.Go_back"
		ai_chance = {
			factor = 1
		}
	}
	after = {
		clr_country_flag = DA_rf_menu_in_use
	}
}	

country_event = {
	id = DA_Magma_forge_event.14 					# unlock creating the wall
	title = "DA_Magma_forge_event.14.t"
	desc = "DA_Magma_forge_event.14.d"
	picture = FORGE_eventPicture

	trigger = {
		capital_scope = {
			has_province_flag = DA_Expanded_dig_adk_8			# research facility lvl 8
		}
		has_country_flag = DA_MF_regulate_veins
		has_country_flag = DA_MF_can_create_regulated_veins
		NOT = { has_country_flag = DA_MF_can_create_Basalt_Wall }
		any_core_province = {
			owned_by = root
			has_province_modifier = DA_GB_vulcano_regulated
			has_province_flag = DA_Expanded_magma_forge_cap1
		}
		any_core_province = {
			owned_by = root
			province_id = 672
		}
	}
	mean_time_to_happen = {
		months = 120
		modifier = {
			factor = 0.9
			innovativeness = 80
		}
		modifier = {
			factor = 0.9
			stability = 3
		}
		modifier = {
			factor = 0.85
			has_country_modifier = DA_Runesmith_patronage
		}
		modifier = {
			factor = 0.90
			OR = {
				has_estate_privilege = estate_DA_Runesmiths_RF_4
				has_estate_privilege = estate_DA_Runesmiths_RF_5
			}
		}
		modifier = {
			factor = 0.85
			OR = {
				has_estate_privilege = estate_DA_Runesmiths_RF_6
				has_estate_privilege = estate_DA_Runesmiths_RF_7
			}
		}
		modifier = {
			factor = 0.80
			OR = {
				has_estate_privilege = estate_DA_Runesmiths_RF_8
				has_estate_privilege = estate_DA_Runesmiths_RF_9
				has_estate_privilege = estate_DA_Runesmiths_RF_10
				has_estate_privilege = estate_DA_Runesmiths_RF_11
			}
		}
	}

	option = {
		name = "DA_Magma_forge_event.14.a"
		goto = 672
		custom_tooltip = DA_Magma_forge_event.14.a.tooltip
		set_country_flag = DA_MF_can_create_Basalt_Wall
		ai_chance = {
			factor = 1
		}
	}
}

country_event = {
	id = DA_Magma_forge_event.15 					# Create the wall event
	title = "DA_Magma_forge_event.15.t"
	desc = "DA_Magma_forge_event.15.d"
	picture = GREAT_BUILDING_eventPicture

	is_triggered_only = yes

	option = {
		name = "DA_Magma_forge_event.15.a"
		goto = 672
		add_treasury = -1000
		custom_tooltip = DA_Magma_forge_event.15.a.tooltip
		672 = {
			add_great_project = {
				type = DA_Verkal_Jorkad
				instant = no
			}
		}
		hidden_effect = {
			every_core_province = {
				limit = {
					has_province_flag = DA_Magma_forge_found
				}
				subtract_variable = {
					which = DA_Magma_level
					value = 200
				}
			}
		}
		ai_chance = {
			factor = 1
		}
	}
}

country_event = {
	id = DA_Magma_forge_event.16 					# tier 0 completed event
	title = "DA_Magma_forge_event.16.t"
	desc = "DA_Magma_forge_event.16.d"
	picture = GREAT_BUILDING_eventPicture

	is_triggered_only = yes

	option = {
		name = "DA_Magma_forge_event.16.a"
		goto = 672
		set_country_flag = DA_MF_can_create_Basalt_Wall
		ai_chance = {
			factor = 1
		}
	}
}

country_event = {
	id = DA_Magma_forge_event.17 					# tier 1 completed event
	title = "DA_Magma_forge_event.17.t"
	desc = "DA_Magma_forge_event.17.d"
	picture = GREAT_BUILDING_eventPicture

	is_triggered_only = yes

	option = {
		name = "DA_Magma_forge_event.17.a"
		goto = 672
		set_country_flag = DA_MF_can_create_Basalt_Wall
		ai_chance = {
			factor = 1
		}
	}
}

country_event = {
	id = DA_Magma_forge_event.18 					# tier 2 completed event
	title = "DA_Magma_forge_event.18.t"
	desc = "DA_Magma_forge_event.18.d"
	picture = GREAT_BUILDING_eventPicture

	is_triggered_only = yes

	option = {
		name = "DA_Magma_forge_event.18.a"
		goto = 672
		set_country_flag = DA_MF_can_create_Basalt_Wall
		ai_chance = {
			factor = 1
		}
	}
}

country_event = {
	id = DA_Magma_forge_event.19 					# tier 3 completed event
	title = "DA_Magma_forge_event.19.t"
	desc = "DA_Magma_forge_event.19.d"
	picture = GREAT_BUILDING_eventPicture

	is_triggered_only = yes

	option = {
		name = "DA_Magma_forge_event.19.a"
		goto = 672
		672 = {
			change_province_name = "Verkal Jorkad"
		}
		set_country_flag = DA_MF_can_create_Basalt_Wall
		ai_chance = {
			factor = 1
		}
	}
}

country_event = {
	id = DA_Magma_forge_event.20 					# prosperity behind the wall
	title = "DA_Magma_forge_event.20.t"
	desc = "DA_Magma_forge_event.20.d"
	picture = GREAT_BUILDING_eventPicture

	fire_only_once = yes
	trigger = {
		673 = { owned_by = root }
		674 = { owned_by = root }
		675 = { owned_by = root }
		676 = { owned_by = root }
		677 = { owned_by = root }
		678 = { owned_by = root }
		any_core_province = {
			province_id = 672
			owned_by = root
			has_great_project = {
				type = DA_Verkal_Jorkad
				tier = 3
			}
		}
	}
	mean_time_to_happen = {
		years = 8
	}


	option = {
		name = "DA_Magma_forge_event.20.a"
		goto = 672
		673 = { add_permanent_province_modifier = {
			name = DA_Prosperity_behind_the_wall
			duration = -1
		} }
		674 = { add_permanent_province_modifier = {
			name = DA_Prosperity_behind_the_wall
			duration = -1
		} }
		675 = { add_permanent_province_modifier = {
			name = DA_Prosperity_behind_the_wall
			duration = -1
		} }
		676 = { add_permanent_province_modifier = {
			name = DA_Prosperity_behind_the_wall
			duration = -1
		} }
		677 = { add_permanent_province_modifier = {
			name = DA_Prosperity_behind_the_wall
			duration = -1
		} }
		678 = { add_permanent_province_modifier = {
			name = DA_Prosperity_behind_the_wall
			duration = -1
		} }
		ai_chance = {
			factor = 1
		}
	}
}
